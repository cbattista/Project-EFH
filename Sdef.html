<html>
<head>

<! Import external scripts >
<link href = "Sdef.css" rel="stylesheet" type = "text/css"> </link>
<script type = "text/javascript" src = "Jquery.js"> </script>
<script type = "text/javascript" src = "timer.js"></script>
<script type = "text/javascript" src = "Subject.js"></script>
<script type = "text/javascript" src = "moveObject.js"></script>
</head>

<body>

<h1> Satellite Defender - Click to make stuff explode</h1>

<! Import images, order is in terms of layering>
<div id = "playground">

	<div id = "mysteryBox"> <img src = "images/SatDef/mysteryBox.png"/></div>
	
	<div id = "binoculars" ><img src = "images/SatDef/binocular.png" /></div>
	
	<div id = "city" ><img src = "images/SatDef/city.png" /></div>

</div>

<! Now for the java script....>
<script type = "text/javascript">

//This function will determine what happens when an object hits the ground
function hitGround() {
	landed = 1;
	
	//Countdown for the animation loop
	landing = 10;
	
	//package hits ground, determine whether it's a good or bad outcome, logs event and set fire to the city
	if (stim == 0) { //If the bomb hits the ground do this...
		subject.inputData(trial, "outcome", "TN");//TN = true negative
		$('#city').html("<img src = \"images/SatDef/explosion.png\" /><img src = \"images/SatDef/city.png\" /><img src = \"images/SatDef/explosion.png\" />");
		//alert('BOOM!');
	}
	else { //If a carepackage hits the ground do this...
		subject.inputData(trial, "outcome", "N");//N = Negative (Why negative? because no action was taken, its a  "good negative")
		//alert('YAY');
	}
	subject.inputData(trial, "RT", 0);//RT = Reaction Time, 0 indicates no action was taken
	
}

// This function determines what happens when the user destroys an object
function detonate() {
	
	detonated = 1;
	
	//user destroys package
	RT = currentTime.getTime() - trialStart;//Reaction time algorithm
	subject.inputData(trial, "RT", RT);

	$('#mysteryBox').html("<img src = \"images/SatDef/explosion.png\" />") 

	if (stim == 0) { //If the user destroys a bomb do this...
		subject.inputData(trial, "outcome", "P");//P = Positive
	}
	else { //If a user destroys a care package do this
		subject.inputData(trial, "outcome", "FP");//FP = False Positive
	}
	
}

//Function to initiate the next trial. Each package dropped is a trial, or opportunity for the user to 'prove' him/herself
function nextTrial() {

	//Revert playground back to its original state
	$('#mysteryBox').html("<img src = \"images/SatDef/mysteryBox.png\" />") 
	$('#city').html("<img src = \"images/SatDef/city.png\" />");
	
	//Increment trial number each time this function is called
	trial = trial + 1;
	
	if (trial <= stimList.length) { //Trial lasts until we run out of bombs/care packages to drop
		//Send to the server which object was sent to the user to be 'delt' with (bomb or care-package)
		stim = stimList[trial];
		subject.inputData(trial, "stim", stim);
		subject.inputData(trial, "stimFile", stimFile[stim]);
	}
	else {
		//alert('Level Complete');
		subject.sendData();
		nextLevel();
	}
	
	setBox(0);
}

function nextLevel() {
	//stuff for making a new stimList etc...
	//setting of game variables - eventually should be retrieved from the database
	trial = 0;
	level = level + 1;
	stimList = [1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 1];
	stimFile = ["bombBox.png", "aidBox.png"];
	//start things off
	stim = stimList[trial];
	//subject.inputLevelData(level, score, currentTime.getTime());
	subject.sendLevelData();
}

function setBox(h) {
	boxpos = h;
	h = h + "px";
	$("#mysteryBox").css("top", h);
}

function incrementBox(h) {
	boxpos = boxpos + h;
	$("#mysteryBox").css("top", boxpos);
}

//Main Program
$(document).ready(function(){

	//Set position of binoculars in the playground
	binocHeightTop = 0;
	$("#binoculars").css("top",binocHeightTop);
	binocHeightBottom = binocHeightTop + 160; //160 is determined by the dimensions of the bincoulars
	
	currentTime = new Date();
	subject = new Subject(666, "satDef");
	
	timeInc = 5; //The rate at which objects drop
	boxpos = 0; //Initial box position

	//decision states for whether the package has been a exploded
	detonated = 0;
	
	burnMax = 10;//How long explosion animation lasts
	burnout = burnMax; 

	//decision states for whether the package has landed
	landed = 0;
	landingMax = 10 //How long the landing animation lasts
	landing = landingMax;
	
	
	//setting of game variables - eventually should be retrieved from the database
	level = 0;
	trial = 0;
	stimList = [0, 0, 0, 1, 1, 0, 1, 1, 1, 0, 0, 0];
	stimFile = ["bombBox.png", "aidBox.png"];
	trialStart = currentTime.getTime();
	//start things off
	
	stim = stimList[trial];
	
	$.timer(40,function(timer){
		
		//incrementBox(timeInc);
		moveObject(timeInc, "#mysteryBox");
		
		//need to check and see if the the package is in the binoculars
		//if ((position.top >= 100) and (position.top <= 200 )) { change picture}


		var position = $("#mysteryBox").position()
		
		
		if (detonated == 0) {
			if (position.top > binocHeightTop) {
				html = "<img src = \"images/SatDef/" + stimFile[stim]  + "\"/>";
				$("#mysteryBox").html(html);			

			}

			if (position.top > binocHeightBottom) {
				html = "<img src = \"images/SatDef/mysteryBox.png\"/>";
				$("#mysteryBox").html(html);			
			}
		}
				
		else  {
			burnout = burnout - 1;
			if (burnout < 0 ) {
				nextTrial();
				burnout = burnMax;
				detonated = 0;
			}
		}
		
		if (landed == 0) {
			if (position.top > 500){
				landed= 1;
				hitGround();
			}
		}
		else {
			landing = landing - 1;
			if (landing < 0) {
				nextTrial();
				landing = landingMax;
				landed = 0;
			}
		}		
		
	});

	$("#playground").click(
		function(event) {
			event.preventDefault();
			//probably should make this button specific at some point
			detonate();
			//}
		}
	);	
	
});

</script>


</body>
</html>